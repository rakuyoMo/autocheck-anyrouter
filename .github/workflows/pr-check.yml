name: PR ä»£ç æ£€æŸ¥

on:
  pull_request:
    branches:
      - '**'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      pull-requests: write
    env:
      PYTHONIOENCODING: utf-8
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: ğŸ”§ å®‰è£… Mise
        uses: jdx/mise-action@v3
        with:
          cache_key: "{{default}}-${{ hashFiles('pyproject.toml') }}"

      - name: âš™ï¸ å®‰è£…ä¾èµ–
        run: mise run install-dev

      - name: ğŸ“ è®¾ç½®é…ç½®å¸¸é‡
        run: |
          # è¦†ç›–ç‡é…ç½®
          echo "COVERAGE_THRESHOLD=59" >> $GITHUB_ENV
          echo "COVERAGE_DETAIL_FILE_COUNT=10" >> $GITHUB_ENV

      - name: ğŸ”„ åˆå§‹åŒ–æ£€æŸ¥çŠ¶æ€
        run: |
          # åˆå§‹åŒ–æ‰€æœ‰æ£€æŸ¥çŠ¶æ€ä¸º pendingï¼Œåªæœ‰æ˜ç¡®æˆåŠŸæˆ–å¤±è´¥æ—¶æ‰æ›´æ–°
          echo "FORMAT_STATUS=pending" >> $GITHUB_ENV
          echo "LINT_STATUS=pending" >> $GITHUB_ENV
          echo "TYPE_STATUS=pending" >> $GITHUB_ENV
          echo "COVERAGE_STATUS=pending" >> $GITHUB_ENV

      - name: ğŸ¨ Ruff æ ¼å¼åŒ–æ£€æŸ¥
        id: format-check
        if: always()
        continue-on-error: true
        uses: astral-sh/ruff-action@v3
        with:
          args: format --check

      - name: ğŸ” Ruff ä»£ç è§„èŒƒæ£€æŸ¥
        id: lint-check
        if: always()
        continue-on-error: true
        uses: astral-sh/ruff-action@v3
        with:
          args: check

      - name: ğŸ” ç±»å‹æ£€æŸ¥
        id: type-check
        if: always()
        continue-on-error: true
        uses: jakebailey/pyright-action@v2
        with:
          annotate: all

      - name: ğŸ“ ä¿å­˜é™æ€æ£€æŸ¥ç»“æœ
        if: always()
        run: |
          # å®šä¹‰å¤„ç†æ£€æŸ¥ç»“æœçš„å‡½æ•°
          save_check_result() {
              local outcome=$1
              local status_var=$2

              if [ "$outcome" == "success" ]; then
                  echo "${status_var}=success" >> $GITHUB_ENV
              elif [ "$outcome" == "failure" ]; then
                  echo "${status_var}=failure" >> $GITHUB_ENV
                  echo "STATIC_CHECK_FAILED=true" >> $GITHUB_ENV
              fi
              # pending çŠ¶æ€ä¿æŒä¸å˜ï¼Œä¸åšå¤„ç†
          }

          # ä¿å­˜å„æ£€æŸ¥ç»“æœ
          save_check_result "${{ steps.format-check.outcome }}" "FORMAT_STATUS"
          save_check_result "${{ steps.lint-check.outcome }}" "LINT_STATUS"
          save_check_result "${{ steps.type-check.outcome }}" "TYPE_STATUS"

      - name: ğŸ§ª è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡
        id: test-run
        if: env.STATIC_CHECK_FAILED != 'true'
        continue-on-error: true
        run: |
          # è¿è¡Œæµ‹è¯•ï¼Œæ•è·é€€å‡ºç å’Œè¾“å‡º
          set +e
          OUTPUT=$(mise run test-cov --cov-report=json 2>&1)
          TEST_EXIT_CODE=$?
          set -e

          # å°è¯•è¯»å–è¦†ç›–ç‡æ•°æ®
          if [ -f "coverage.json" ]; then
              COVERAGE_PERCENT=$(python3 -c "import json; data=json.load(open('coverage.json')); print(f\"{data['totals']['percent_covered']:.2f}\")")
              echo "COVERAGE_PERCENT=$COVERAGE_PERCENT" >> $GITHUB_ENV
          fi

          # æ ¹æ®æµ‹è¯•ç»“æœè®¾ç½®çŠ¶æ€
          if [ $TEST_EXIT_CODE -eq 0 ]; then
              # æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼Œæ£€æŸ¥è¦†ç›–ç‡
              if python3 -c "import sys; sys.exit(0 if float('$COVERAGE_PERCENT') >= $COVERAGE_THRESHOLD else 1)"; then
                  echo "COVERAGE_STATUS=success" >> $GITHUB_ENV
              else
                  echo "COVERAGE_STATUS=failure" >> $GITHUB_ENV
                  exit 1
              fi
          else
              # æµ‹è¯•å¤±è´¥ï¼Œä¿å­˜é”™è¯¯ä¿¡æ¯
              echo "COVERAGE_STATUS=failure" >> $GITHUB_ENV
              echo "$OUTPUT" > test-errors.txt
              exit 1
          fi

      - name: ğŸ“Š ç”Ÿæˆè¦†ç›–ç‡è¯¦ç»†ä¿¡æ¯
        if: steps.test-run.outcome != 'skipped'
        run: python3 .github/scripts/generate_coverage_detail.py

      - name: ğŸ’¬ å‘å¸ƒæ£€æŸ¥æŠ¥å‘Šåˆ° PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const { postPRComment } = require('./.github/scripts/post_pr_comment.js');
            await postPRComment(github, context);

      - name: âœ… æ£€æŸ¥æœ€ç»ˆçŠ¶æ€
        if: always()
        run: |
          if [ "$FORMAT_STATUS" == "failure" ] || [ "$LINT_STATUS" == "failure" ] || [ "$TYPE_STATUS" == "failure" ] || [ "$COVERAGE_STATUS" == "failure" ]; then
              exit 1
          fi
